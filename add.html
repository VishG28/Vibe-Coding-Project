<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skimp Maps - Add Report</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; }
    nav a { margin-right: 1rem; }
    #results { margin-top: 1rem; }
    .location { margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="map.html">View Map</a>
  </nav>
  <h1>Add a Chipotle</h1>
  <p>Search by ZIP code to find Chipotle locations near you and add your report.</p>
  <input type="text" id="zip" placeholder="ZIP code">
  <label for="radius">Radius:</label>
  <select id="radius" onchange="toggleCustom()">
    <option value="5">5 miles</option>
    <option value="10">10 miles</option>
    <option value="15">15 miles</option>
    <option value="custom">Custom</option>
  </select>
  <input type="number" id="customRadius" placeholder="Miles" style="display:none; width:6em;">
  <button onclick="search()">Search</button>

  <div id="results"></div>

  <script>
    let locations = [];
    async function loadData() {
      const response = await fetch('chipotle_locations.json');
      locations = await response.json();
    }
    loadData();

    function toggleCustom() {
      const select = document.getElementById('radius');
      const custom = document.getElementById('customRadius');
      custom.style.display = select.value === 'custom' ? 'inline' : 'none';
    }

    function getRadius() {
      const select = document.getElementById('radius');
      if (select.value === 'custom') {
        const val = parseFloat(document.getElementById('customRadius').value);
        return isNaN(val) || val <= 0 ? 5 : val;
      }
      return parseFloat(select.value);
    }

    async function fetchLiveChipotles(lat, lng, radiusMiles) {
      const km = radiusMiles * 1.60934;
      const query = `[out:json];node["name"~"Chipotle"](around:${Math.round(km * 1000)},${lat},${lng});out;`;
      const url = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query);
      const resp = await fetch(url);
      if (!resp.ok) throw new Error('Overpass error');
      const data = await resp.json();
      return data.elements.map(el => ({
        name: el.tags.name || 'Chipotle Mexican Grill',
        address: [el.tags['addr:housenumber'], el.tags['addr:street'], el.tags['addr:city'], el.tags['addr:state']].filter(Boolean).join(' '),
        lat: el.lat,
        lng: el.lon
      }));
    }

    async function search() {
      const zip = document.getElementById('zip').value.trim();
      const container = document.getElementById('results');
      container.innerHTML = '';

      if (!zip) {
        container.textContent = 'Please enter a ZIP code.';
        return;
      }

      let center;
      try {
        const resp = await fetch(`https://api.zippopotam.us/us/${zip}`);
        if (!resp.ok) throw new Error('bad response');
        const data = await resp.json();
        const place = data.places[0];
        center = { lat: parseFloat(place.latitude), lng: parseFloat(place.longitude) };
      } catch (e) {
        container.textContent = 'Could not locate that ZIP code.';
        return;
      }

      const radius = getRadius();
      let results = [];
      try {
        results = await fetchLiveChipotles(center.lat, center.lng, radius);
      } catch (e) {
        // fall back to bundled data
        results = locations.filter(l => {
          const d = distance(center.lat, center.lng, l.lat, l.lng);
          return d <= radius;
        });
      }

      if (results.length === 0) {
        container.textContent = 'No Chipotle locations found within ' + radius + ' miles.';
        return;
      }

      results.forEach(loc => {
        const div = document.createElement('div');
        div.className = 'location';
        let label = loc.address ? `${loc.name} - ${loc.address}` : loc.name;
        if (loc.zip) label += ' (ZIP ' + loc.zip + ')';
        div.textContent = label;
        const btn = document.createElement('button');
        btn.textContent = 'Report Skimp';
        btn.onclick = () => saveReport(loc);
        div.appendChild(btn);
        container.appendChild(div);
      });
    }

    function distance(lat1, lon1, lat2, lon2) {
      const toRad = deg => deg * Math.PI / 180;
      const R = 3958.8; // Earth radius in miles
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function saveReport(loc) {
      const reports = JSON.parse(localStorage.getItem('reports') || '[]');
      reports.push({ name: loc.name, address: loc.address, zip: loc.zip });
      localStorage.setItem('reports', JSON.stringify(reports));
      alert('Thank you! Your report was saved locally.');
    }
  </script>
</body>
</html>
